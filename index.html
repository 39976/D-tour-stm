async function afficherArretsSTM(map) {
    const url = "https://overpass-api.de/api/interpreter";

    const stopsQuery = `
    [out:json][timeout:35];
    (
      node["highway"="bus_stop"]["operator"="STM"](area:3600065600);
      node["highway"="bus_stop"]["network"="STM"](area:3600065600);
    );
    out body;
    >;
    out skel qt;
    `;

    const stopsResponse = await fetch(url, { method: "POST", body: stopsQuery });
    const stopsData = await stopsResponse.json();

    for (const stop of stopsData.elements) {

        const marker = L.circleMarker([stop.lat, stop.lon], {
            radius: 6,
            color: "#007bff",
            fillColor: "#2d8cff",
            fillOpacity: 0.9,
            weight: 1
        }).addTo(map);

        marker.on("click", () => afficherLignesPourArret(stop, marker));
    }
}


async function afficherLignesPourArret(stop, marker) {

    const url = "https://overpass-api.de/api/interpreter";

    const relationsQuery = `
    [out:json][timeout:35];
    rel(bn:${stop.id})["route"="bus"]["network"="STM"];
    out body;
    `;

    const res = await fetch(url, { method: "POST", body: relationsQuery });
    const data = await res.json();

    // Préparer la liste des lignes
    const lignes = data.elements.map(rel => {
        const ref = rel.tags.ref || "???";
        const dir = rel.tags.direction || rel.tags.to || "—";
        return `${ref} → ${dir}`;
    });

    const stopId = stop.tags["ref:STM"] || stop.tags["ref:stop_id"] || stop.tags.ref || stop.id;
    const stopName = stop.tags.name || "Arrêt STM";

    const popupHtml = `
        <b>${stopName}</b><br>
        <b>ID STM :</b> ${stopId}<br>
        <b>Lignes :</b><br>
        ${lignes.length ? lignes.map(l => "• " + l).join("<br>") : "Aucune donnée"}
    `;

    marker.bindPopup(popupHtml).openPopup();
}


afficherArretsSTM(map);
