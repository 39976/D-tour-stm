<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DÃ©tours STM</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .info-box {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 14px;
            border-radius: 12px;
            font-size: 18px;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="info-box">ðŸ‘‰ Clique une rue : jâ€™affiche la rue EXACTE + les lignes STM.</div>
<div id="map"></div>

<script>
// ===============================
// ðŸ—ºï¸ 1. INITIALISATION CARTE
// ===============================
const map = L.map("map").setView([45.5017, -73.5673], 15);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

// ===============================
// ðŸŸ£ 2. LAYER POUR LA LIGNE CLIQUÃ‰E
// ===============================
let streetLayer = L.geoJSON(null, {
    style: { color: "#7c00ff", weight: 6 }
}).addTo(map);

// ===============================
// ðŸš 3. LISTE DES LIGNES STM (simplifiÃ©e)
// ===============================
const stmLines = [
    { name: "24", streets: ["Sherbrooke", "Rue Sherbrooke Ouest", "Rue Sherbrooke Est"] },
    { name: "105", streets: ["Sherbrooke", "Rue Sherbrooke Ouest"] },
    { name: "138", streets: ["Sherbrooke", "Rue Sherbrooke Ouest"] },
    { name: "356", streets: ["Sherbrooke", "Rue Sherbrooke Ouest"] }
];

// ===============================
// ðŸŽ¯ 4. DÃ‰TECTION DE LA RUE CLIQUÃ‰E
// ===============================
map.on("click", async function (e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    // Reverse geocoding
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
    const data = await fetch(url).then(r => r.json());

    if (!data || !data.address || !data.address.road) {
        alert("Impossible de dÃ©tecter cette rue.");
        return;
    }

    const street = data.address.road;

    // ===============================
    // ðŸšŒ TROUVER LES LIGNES STM ASSOCIEÌES
    // ===============================
    const matchingLines = stmLines
        .filter(l => l.streets.some(s => street.includes(s)))
        .map(l => l.name);

    // ===============================
    // ðŸŸ£ AFFICHER LE TRACÃ‰ EXACT DE LA RUE
    // ===============================
    streetLayer.clearLayers();

    const searchUrl = `https://nominatim.openstreetmap.org/search?street=${encodeURIComponent(street)}&city=MontrÃ©al&format=json&polygon_geojson=1`;

    const streetData = await fetch(searchUrl).then(r => r.json());

    if (streetData.length > 0 && streetData[0].geojson) {
        streetLayer.addData(streetData[0].geojson);
    }

    // ===============================
    // ðŸ“Œ POPUP
    // ===============================
    L.popup()
        .setLatLng(e.latlng)
        .setContent(`
            <b>Rue :</b> ${street}<br>
            <b>Lignes STM :</b> ${matchingLines.length ? matchingLines.join(", ") : "Aucune trouvÃ©e"}
        `)
        .openOn(map);
});

</script>

</body>
</html>
