<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DÃ©tours STM â€“ Correction multi-ways</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }

    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }
  </style>
</head>

<body>

<div id="panel">
  ðŸ‘‰ Clique une rue : jâ€™affiche la rue EXACTE + les lignes STM associÃ©es + le tracÃ© (multi-ways corrigÃ©).
</div>

<div id="map"></div>

<script>
const map = L.map('map').setView([45.508, -73.587], 13);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let activeLines = [];
let activeRoadSegments = [];

// Effacer les tracÃ©s existants
function clearMap() {
  activeLines.forEach(l => map.removeLayer(l));
  activeRoadSegments.forEach(l => map.removeLayer(l));
  activeLines = [];
  activeRoadSegments = [];
}

// --- 1) RÃ©cupÃ©rer la rue exacte du clic ---
async function getClickedStreet(lat, lng) {
  const query = `
    [out:json];
    way(around:20, ${lat}, ${lng})["highway"]["name"];
    out body;
  `;
  const res = await fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query });
  const json = await res.json();

  if (!json.elements.length) return null;

  return json.elements[0];   // return full WAY
}

// --- 2) Trouver tous les ways du mÃªme nom dans un rayon ---
async function getAllStreetWays(streetName, lat, lng) {
  const query = `
    [out:json];
    way(around:35, ${lat}, ${lng})["highway"]["name"="${streetName}"];
    out geom;
    relation(bn)->.rels;
  `;

  const res = await fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query });
  return (await res.json()).elements.filter(e => e.type === "way");
}

// --- 3) Trouver les lignes STM (relations) pour un way ---
async function getBusLinesForWay(wayId) {
  const query = `
    [out:json];
    relation["route"="bus"](way(${wayId}));
    out tags;
  `;
  const res = await fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query });
  const json = await res.json();

  return json.elements.map(r => r.tags.ref).filter(Boolean);
}

// --- 4) TracÃ© des segments + couleurs ---
function drawRoadSegment(way) {
  const coords = way.geometry.map(p => [p.lat, p.lon]);
  const poly = L.polyline(coords, {
    color: "blue",
    weight: 5
  }).addTo(map);

  activeRoadSegments.push(poly);
}

// -------- CLIC SUR LA CARTE ---------
map.on("click", async e => {
  clearMap();

  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  const popup = L.popup().setLatLng(e.latlng).setContent("Rechercheâ€¦").openOn(map);

  // 1) Trouve le way cliquÃ©
  const clickedWay = await getClickedStreet(lat, lng);
  if (!clickedWay) {
    popup.setContent("Rue introuvable");
    return;
  }

  const streetName = clickedWay.tags.name;

  // 2) Trouve tous les ways du mÃªme nom
  const allWays = await getAllStreetWays(streetName, lat, lng);

  let allLines = new Set();
  let waysContainingLines = [];

  // 3) Pour chaque way : cherche les bus
  for (const way of allWays) {
    const lines = await getBusLinesForWay(way.id);

    if (lines.length > 0) {
      lines.forEach(l => allLines.add(l));
      waysContainingLines.push(way);
    }
  }

  // 4) Si aucun way nâ€™a de bus â†’ afficher sans tracer
  if (waysContainingLines.length === 0) {
    popup.setContent(`
      <b>Rue :</b> ${streetName}<br>
      <b>Lignes STM :</b> Aucune donnÃ©e
    `);
    return;
  }

  // 5) Trace UNIQUEMENT les ways contenant des bus
  waysContainingLines.forEach(drawRoadSegment);

  popup.setContent(`
    <b>Rue :</b> ${streetName}<br>
    <b>Lignes STM :</b> ${[...allLines].join(", ")}
  `);
});
</script>

</body>
</html>
