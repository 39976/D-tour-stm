<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DÃ©tours STM â€“ DÃ©mo rues</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #map {
      position: absolute;
      inset: 0;
      z-index: 1;
    }
    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      z-index: 1000;
    }
    #clearBtn {
      background:#d9534f;
      color:white;
      padding:10px 15px;
      border:none;
      border-radius:6px;
      font-size:16px;
      cursor:pointer;
    }
  </style>
</head>

<body>

  <div id="panel">
    <label>Ligne bus :</label>
    <input id="ligne" type="text" placeholder="(facultatif)">
    <br><br>
    <button id="clearBtn">Effacer tracÃ©s</button>
    <p style="margin-top:10px;">
      ðŸ‘‰ Clique sur une rue.<br>
      â€¢ Si câ€™est <b>Rue Sherbrooke Ouest</b> ou <b>Rue Sherbrooke Est</b>,<br>
      â†’ jâ€™affiche les lignes STM.<br>
      â€¢ Sinon : aucun tracÃ© (dÃ©mo).
    </p>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // ============================================================
  // CARTE
  // ============================================================
  const map = L.map('map').setView([45.51, -73.58], 12);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let displayedLines = [];
  function clearLines() {
    displayedLines.forEach(l => map.removeLayer(l));
    displayedLines = [];
  }
  document.getElementById("clearBtn").onclick = clearLines;

  // ============================================================
  // LIGNES DE BUS (dÃ©mo)
  // ============================================================
  const streetLines = {
    "Rue Sherbrooke Ouest": ["24", "105", "138", "356"],
    "Rue Sherbrooke Est":  ["24", "125", "185", "356"]
  };

  const lineColors = {
    "24":  "blue",
    "105": "red",
    "138": "green",
    "356": "purple",
    "125": "orange",
    "185": "brown"
  };

  // ============================================================
  // NOM DE LA RUE VIA OVERPASS
  // ============================================================
  async function getStreetName(lat, lng) {
    const query = `
      [out:json];
      way(around:20, ${lat}, ${lng})["highway"]["name"];
      out tags;
    `;
    try {
      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: query
      });
      const json = await res.json();
      if (json.elements.length > 0) {
        return json.elements[0].tags.name || "Rue inconnue";
      }
    } catch (e) { console.error(e); }
    return "Rue inconnue";
  }

  // ============================================================
  // TRACER LIGNES
  // ============================================================
  function drawLinesForStreet(streetName, lat, lng) {
    clearLines();

    const lignes = streetLines[streetName] || [];

    lignes.forEach(num => {
      const col = lineColors[num] || "#0072bc";
      const poly = L.polyline(
        [[lat - 0.001, lng - 0.01], [lat, lng], [lat + 0.001, lng + 0.01]],
        { color: col, weight: 5, opacity: 0.9 }
      ).addTo(map);
      displayedLines.push(poly);
    });

    return lignes;
  }

  // ============================================================
  // CLICK SUR LA CARTE
  // ============================================================
  map.on("click", async (e) => {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    const popup = L.popup()
      .setLatLng(e.latlng)
      .setContent("Recherche de la rueâ€¦")
      .openOn(map);

    const street = await getStreetName(lat, lng);
    const lignes = drawLinesForStreet(street, lat, lng);

    popup.setContent(`
      <b>Rue :</b> ${street}<br>
      <b>Lignes STM :</b> ${lignes.length ? lignes.join(", ") : "aucune"}
    `);
  });

  </script>

</body>
</html>
