<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Détours STM – v2.5 (Entrave réelle)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; background: #f3f3f3; }
    #map { height: 55vh; }
    .panel { padding: 12px; background: white; }
    button { width: 100%; margin-top: 10px; padding: 10px; border-radius: 6px; border: none; font-size: 16px; }
    .ok { background: #1976d2; color: white; }
    .reset { background: #ddd; color: black; }
    .chip { display: inline-block; padding: 4px 8px; background: #e3f2fd; border-radius: 8px; margin: 2px; font-size: 12px; }
  </style>
</head>
<body>

<div class="panel">
  <h2>Détours STM – v2.5</h2>
  <p>1️⃣ Clique le point AVANT<br>2️⃣ Clique le point APRÈS<br>3️⃣ Calcule le détour</p>
  <div id="chips"></div>
  <button id="btn" class="ok" disabled>Calculer le détour</button>
  <button id="reset" class="reset">Réinitialiser</button>
  <div id="status"></div>
</div>

<div id="map"></div>

<div class="panel">
  <div id="steps"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map("map").setView([45.52, -73.57], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let start = null, end = null;
let m1 = null, m2 = null, routeLayer = null;

function updateChips() {
  let div = document.getElementById("chips");
  div.innerHTML = "";
  if (start) div.innerHTML += `<span class="chip">AVANT : ${start.lat.toFixed(5)}, ${start.lng.toFixed(5)}</span>`;
  if (end) div.innerHTML += `<span class="chip">APRÈS : ${end.lat.toFixed(5)}, ${end.lng.toFixed(5)}</span>`;
  document.getElementById("btn").disabled = !(start && end);
}

// Snap-to-road
async function snap(lat, lng) {
  let url = `https://router.project-osrm.org/nearest/v1/driving/${lng},${lat}`;
  let j = await (await fetch(url)).json();
  if (j && j.waypoints && j.waypoints.length)
    return { lat: j.waypoints[0].location[1], lng: j.waypoints[0].location[0] };
  return { lat, lng };
}

// Polygon around road closure
function buildAvoidPolygon(s, e) {
  // petit rectangle autour du segment
  let dx = e.lng - s.lng;
  let dy = e.lat - s.lat;

  let n = 0.0002; // largeur du polygone (~20m)

  let poly = [
    [s.lng - dy*n, s.lat + dx*n],
    [s.lng + dy*n, s.lat - dx*n],
    [e.lng + dy*n, e.lat - dx*n],
    [e.lng - dy*n, e.lat + dx*n],
    [s.lng - dy*n, s.lat + dx*n] // close
  ];

  return poly.map(p => p.join(",")).join(";");
}

map.on("click", async e => {
  let p = await snap(e.latlng.lat, e.latlng.lng);

  if (!start) {
    start = p;
    if (m1) map.removeLayer(m1);
    m1 = L.marker(start).addTo(map);
  } else if (!end) {
    end = p;
    if (m2) map.removeLayer(m2);
    m2 = L.marker(end).addTo(map);
  } else {
    // reset auto
    resetAll();
    start = p;
    m1 = L.marker(start).addTo(map);
  }

  updateChips();
});

async function calc() {
  document.getElementById("status").innerHTML = "Calcul du détour...";
  document.getElementById("steps").innerHTML = "";

  // construction du polygone d’entrave
  let poly = buildAvoidPolygon(start, end);

  let url =
    `https://router.project-osrm.org/route/v1/driving/` +
    `${start.lng},${start.lat};${end.lng},${end.lat}` +
    `?geometries=geojson&overview=full&steps=true&exclude=poly:${poly}`;

  let res = await fetch(url);
  let data = await res.json();

  if (!data.routes || !data.routes.length) {
    document.getElementById("status").innerHTML =
      "<span style='color:red;'>Impossible de calculer un détour</span>";
    return;
  }

  let r = data.routes[0];

  if (routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.geoJSON(r.geometry).addTo(map);

  map.fitBounds(routeLayer.getBounds());

  document.getElementById("status").innerHTML =
    `Distance : ${(r.distance/1000).toFixed(2)} km – Temps : ${(r.duration/60).toFixed(0)} min`;

  let html = "<h3>Instructions :</h3>";
  r.legs[0].steps.forEach((s, i) => html += `${i+1}. ${s.maneuver.instruction}<br>`);
  document.getElementById("steps").innerHTML = html;
}

function resetAll() {
  start = end = null;
  if (m1) map.removeLayer(m1);
  if (m2) map.removeLayer(m2);
  if (routeLayer) map.removeLayer(routeLayer);
  m1 = m2 = routeLayer = null;
  document.getElementById("chips").innerHTML = "";
  document.getElementById("status").innerHTML = "";
  document.getElementById("steps").innerHTML = "";
}

document.getElementById("btn").onclick = calc;
document.getElementById("reset").onclick = resetAll;
</script>

</body>
</html>
