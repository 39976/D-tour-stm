<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DÃ©tours STM â€“ Stable No-Block</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body { height: 100%; margin:0; padding:0; }
  #map { height:100%; width:100%; }
  #panel {
    position:absolute; top:10px; left:10px; right:10px;
    background:white; padding:10px; border-radius:12px;
    font-size:18px; z-index:1000;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
  }
</style>
</head>

<body>

<div id="panel">
ğŸ‘‰ Clique une rue : jâ€™affiche la rue EXACTE + les lignes STM + tracÃ©.  
ğŸ’¡ **Version ultra-stable (anti-bug â€œRechercheâ€¦â€)**
</div>

<div id="map"></div>

<script>
const map = L.map("map").setView([45.508, -73.587], 13);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let activeRoad = [];

// Timeout sÃ©curisÃ©
function timeoutPromise(ms) {
  return new Promise((resolve, reject) =>
    setTimeout(() => reject("timeout"), ms)
  );
}

// Effacer
function clearMap() {
  activeRoad.forEach(l => map.removeLayer(l));
  activeRoad = [];
}

// 1ï¸âƒ£ Way cliquÃ©
async function getClickedWay(lat, lng) {
  const q = `
    [out:json][timeout:3];
    way(around:20, ${lat}, ${lng})["highway"]["name"];
    out geom;
  `;

  try {
    const res = await Promise.race([
      fetch("https://overpass-api.de/api/interpreter", { method:"POST", body:q }),
      timeoutPromise(2500)
    ]);
    const json = await res.json();
    return json.elements[0] || null;
  } catch (e) {
    return null;
  }
}

// 2ï¸âƒ£ Tous les segments
async function getStreetSegments(name, lat, lng) {
  const q = `
    [out:json][timeout:3];
    way(around:40, ${lat}, ${lng})["highway"]["name"="${name}"];
    out geom;
  `;
  try {
    const res = await Promise.race([
      fetch("https://overpass-api.de/api/interpreter", { method:"POST", body:q }),
      timeoutPromise(2500)
    ]);
    const json = await res.json();
    return json.elements.filter(e => e.type === "way");
  } catch (e) {
    return [];
  }
}

// 3ï¸âƒ£ Lignes STM sur way
async function getLines(wayId) {
  const q = `
    [out:json][timeout:3];
    relation["route"="bus"](way(${wayId}));
    out tags;
  `;
  try {
    const res = await Promise.race([
      fetch("https://overpass-api.de/api/interpreter", { method:"POST", body:q }),
      timeoutPromise(2500)
    ]);
    const json = await res.json();
    return json.elements.map(r => r.tags.ref).filter(Boolean);
  } catch {
    return [];
  }
}

// 4ï¸âƒ£ tracer
function drawSeg(way) {
  const c = way.geometry.map(p => [p.lat, p.lon]);
  const l = L.polyline(c, { color:"blue", weight:5 }).addTo(map);
  activeRoad.push(l);
}

// ğŸ–±ï¸ CLIC
map.on("click", async e => {
  clearMap();

  const popup = L.popup()
    .setLatLng(e.latlng)
    .setContent("Rechercheâ€¦")
    .openOn(map);

  const { lat, lng } = e.latlng;

  // Ã‰tape 1 : rue cliquÃ©e
  const clicked = await getClickedWay(lat, lng);
  if (!clicked) {
    popup.setContent("Rue introuvable");
    return;
  }

  const name = clicked.tags.name;

  // Ã‰tape 2 : tous les segments
  const segments = await getStreetSegments(name, lat, lng);

  if (segments.length === 0) {
    popup.setContent(`<b>Rue :</b> ${name}<br>Aucun segment trouvÃ©.`);
    return;
  }

  // Ã‰tape 3 : lignes STM sur chaque segment
  let all = new Set();
  let valids = [];

  for (const s of segments) {
    const lines = await getLines(s.id);

    if (lines.length > 0) {
      lines.forEach(x => all.add(x));
      valids.push(s);
    }
  }

  // Si aucun segment nâ€™a de lignes STM â†’ on affiche quand mÃªme
  if (valids.length === 0) {
    popup.setContent(`
      <b>Rue :</b> ${name}<br>
      <b>Lignes STM :</b> Aucune donnÃ©e.
    `);
    return;
  }

  // Tracer les bons segments
  valids.forEach(drawSeg);

  popup.setContent(`
    <b>Rue :</b> ${name}<br>
    <b>Lignes STM :</b> ${[...all].join(", ")}
  `);
});
</script>

</body>
</html>
