<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détours STM – Cliquer l'entrave</title>

    <!-- Leaflet -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        /* Boîte en haut avec la ligne + instructions */
        #top-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 10px 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #top-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #top-row label {
            font-weight: bold;
            white-space: nowrap;
        }

        #ligneInput {
            flex: 1;
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        #btnClear {
            padding: 6px 10px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            background: #ff4d4d;
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }

        #instructions {
            font-size: 12px;
            color: #333;
        }

        /* Boutons Avant/Après en bas à droite (comme tu avais) */
        #floating-actions {
            position: fixed;
            bottom: 25px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 999;
        }

        .fab {
            background: white;
            padding: 12px 18px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .fab-red {
            background: #ff4d4d;
            color: white;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="top-panel">
    <div id="top-row">
        <label for="ligneInput">Ligne bus :</label>
        <input id="ligneInput" type="text" value="186" />
        <button id="btnClear">Effacer détour</button>
    </div>
    <div id="instructions">
        1er clic sur la carte : <b>début de l'entrave</b> –
        2e clic : <b>fin de l'entrave</b> → calcul du détour
    </div>
</div>

<div id="floating-actions">
    <button class="fab" id="avantBtn">Avant</button>
    <button class="fab fab-red" id="apresBtn">Après</button>
</div>

<script>
/* ================== GraphHopper ================== */

// Mets TA clé ici
const API_KEY = "1adf955d-015a-43ae-a58b-0e3c04d6a8d4";

function decodePolyline(encoded) {
    let coords = [];
    let index = 0, lat = 0, lng = 0;

    while (index < encoded.length) {
        let b, shift = 0, result = 0;

        do {
            b = encoded.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);

        let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
        lat += dlat;

        shift = 0;
        result = 0;

        do {
            b = encoded.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);

        let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
        lng += dlng;

        coords.push([lat / 1e5, lng / 1e5]);
    }

    return coords;
}

async function getRoute(points) {
    let url =
        "https://graphhopper.com/api/1/route?" +
        "key=" + API_KEY +
        "&vehicle=bus" +         // bus = même réseau routier que car mais sémantique correcte
        "&profile=car" +         // profil par défaut gratuit
        "&locale=fr" +
        "&points_encoded=true" +
        "&instructions=false";

    points.forEach(p => {
        url += `&point=${p.lat},${p.lng}`;
    });

    const res = await fetch(url);
    const data = await res.json();
    console.log("Réponse GraphHopper :", data);

    if (!data.paths || !data.paths[0]) {
        alert("Aucun chemin trouvé (vérifie que les points sont sur des rues)");
        return null;
    }

    return decodePolyline(data.paths[0].points);
}

/* ================== Carte Leaflet ================== */

let map = L.map("map").setView([45.51, -73.56], 14);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

/* ================== Éléments de l'UI ================== */

let ligneInput = document.getElementById("ligneInput");
let btnClear   = document.getElementById("btnClear");

let markerDebut = null;
let markerFin   = null;
let detourLayer = null;
let routeAvantLayer = null;

let entraveStart = null;
let entraveEnd   = null;
let clickState   = "start";   // "start" puis "end"

/* ========== Clic sur la carte : choisir l'entrave ========== */
map.on("click", async (e) => {
    const ligne = ligneInput.value.trim() || "???";

    if (clickState === "start") {
        // Effacer ancien détour si on recommence
        clearDetour();

        entraveStart = e.latlng;

        markerDebut = L.marker(entraveStart).addTo(map)
            .bindPopup(`Début de l'entrave<br>Ligne ${ligne}`)
            .openPopup();

        clickState = "end";
    }
    else if (clickState === "end") {
        entraveEnd = e.latlng;

        markerFin = L.marker(entraveEnd).addTo(map)
            .bindPopup(`Fin de l'entrave<br>Ligne ${ligne}`)
            .openPopup();

        clickState = "done";

        // Calcul du détour
        await calculerDetour();
    }
});

/* ========== Calculer le détour entre début et fin ========== */
async function calculerDetour() {
    if (!entraveStart || !entraveEnd) return;

    // Pour l’instant : simple route entre début et fin de l’entrave
    const coords = await getRoute([
        { lat: entraveStart.lat, lng: entraveStart.lng },
        { lat: entraveEnd.lat,   lng: entraveEnd.lng }
    ]);

    if (!coords) return;

    if (detourLayer) map.removeLayer(detourLayer);

    detourLayer = L.polyline(coords, {
        color: "red",
        weight: 5
    }).addTo(map);

    map.fitBounds(detourLayer.getBounds());
}

/* ========== Bouton Effacer détour ========== */
function clearDetour() {
    if (markerDebut) { map.removeLayer(markerDebut); markerDebut = null; }
    if (markerFin)   { map.removeLayer(markerFin);   markerFin   = null; }
    if (detourLayer) { map.removeLayer(detourLayer); detourLayer = null; }

    entraveStart = null;
    entraveEnd   = null;
    clickState   = "start";
}

btnClear.onclick = clearDetour;

/* ========== Boutons Avant / Après (optionnel) ========== */
/* Ici je les garde simples : "Avant" = itinéraire direct,
   "Après" = itinéraire qui passe par le détour (début -> fin de l'entrave) */

const startGlobal = { lat: 45.51, lng: -73.57 };
const endGlobal   = { lat: 45.52, lng: -73.55 };

document.getElementById("avantBtn").onclick = async () => {
    if (routeAvantLayer) map.removeLayer(routeAvantLayer);

    const coords = await getRoute([startGlobal, endGlobal]);
    if (!coords) return;

    routeAvantLayer = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);
    map.fitBounds(routeAvantLayer.getBounds());
};

document.getElementById("apresBtn").onclick = async () => {
    if (!entraveStart || !entraveEnd) {
        alert("Clique d'abord le début et la fin de l'entrave sur la carte.");
        return;
    }

    if (routeAvantLayer) map.removeLayer(routeAvantLayer);

    // Exemple simple : trajet global mais qui passe par début et fin de l’entrave
    const coords = await getRoute([
        startGlobal,
        entraveStart,
        entraveEnd,
        endGlobal
    ]);

    if (!coords) return;

    routeAvantLayer = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);
    map.fitBounds(routeAvant
