<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>D√©tours STM</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<style>
    body { margin:0; padding:0; }
    #map { height: 100vh; width: 100vw; }
    #panel {
        position: absolute; top: 10px; left: 10px;
        background: white; padding: 15px;
        border-radius: 10px; z-index: 9999;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        width: calc(100vw - 40px);
        max-width: 450px;
    }
    input { width:100%; padding:8px; font-size:18px; }
    button {
        margin-top:10px; padding:10px;
        width:100%; font-size:18px;
        border:none; border-radius:8px;
        background:#ff4444; color:white;
    }
</style>
</head>

<body>

<div id="panel">
    <strong>Ligne bus :</strong>
    <input id="ligne" type="text" placeholder="Ex : 186">

    <button onclick="resetDetour()">Effacer d√©tour</button>

    <p>
        1er clic : d√©but du d√©tour<br>
        2e clic : fin du d√©tour ‚Üí calcul du trajet
    </p>
</div>

<div id="map"></div>

<script>

// ---------------------------
//    PARAM√àTRES GLOBAUX
// ---------------------------
const API_KEY = "1adf955d-015a-43ae-a58b-0e3c04d6a8d4";   // D√©j√† int√©gr√© üî•

let map = L.map("map").setView([45.55, -73.65], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

let markers = [];
let detourLine = null;

// ---------------------------
//  CLIQUE POUR POINTS
// ---------------------------
map.on("click", function(e) {
    if (markers.length >= 2) return;

    let m = L.marker(e.latlng).addTo(map);
    markers.push(m);

    if (markers.length === 2) {
        calculateDetour();
    }
});

// ---------------------------
// Effacer d√©tour
// ---------------------------
function resetDetour() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    if (detourLine) map.removeLayer(detourLine);
    detourLine = null;
}

// ---------------------------
//  APPEL API GRAPHHOPPER
// ---------------------------
async function calculateDetour() {
    if (markers.length < 2) return;

    const p1 = markers[0].getLatLng();
    const p2 = markers[1].getLatLng();

    let url = `https://graphhopper.com/api/1/route?key=${API_KEY}` +
              `&vehicle=car&locale=fr&points_encoded=false` +
              `&point=${p1.lat},${p1.lng}` +
              `&point=${p2.lat},${p2.lng}`;

    try {
        const res = await fetch(url);
        const json = await res.json();

        if (!json.paths || json.paths.length === 0) {
            alert("Aucun chemin trouv√© pour ce d√©tour");
            return;
        }

        // D√©codage polyline
        const pts = json.paths[0].points.coordinates.map(c => [c[1], c[0]]);

        if (detourLine) map.removeLayer(detourLine);

        detourLine = L.polyline(pts, {
            color: "red",
            weight: 5
        }).addTo(map);

        map.fitBounds(detourLine.getBounds());

    } catch (err) {
        alert("Erreur API");
        console.error(err);
    }
}

</script>
</body>
</html>
