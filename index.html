<script>
  const map = L.map('map');

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  map.setView([45.52, -73.55], 12);

  // =========================
  // LIGNES STM (simplifiées démo)
  // =========================

  const ligne24 = [
    [45.49055, -73.58818],
    [45.50369, -73.56845],
    [45.51515, -73.55476],
    [45.52420, -73.54320],
    [45.53110, -73.53400],
    [45.54355, -73.51700],
    [45.54610, -73.51320]
  ];

  const ligne185 = [
    [45.52420, -73.54320],
    [45.52360, -73.52800],
    [45.52310, -73.51400],
    [45.52270, -73.50000],
    [45.52230, -73.48600],
    [45.52210, -73.47900]
  ];

  const ligne14 = [
    [45.5210, -73.5601],
    [45.5170, -73.5630],
    [45.5143, -73.5659]
  ];

  const lignesSTM = [
    { num: "24",  color: "blue",  coords: ligne24 },
    { num: "185", color: "red",   coords: ligne185 },
    { num: "14",  color: "green", coords: ligne14 }
  ];

  let displayedLines = [];

  function clearLines() {
    displayedLines.forEach(l => map.removeLayer(l));
    displayedLines = [];
  }

  document.getElementById("clearBtn").onclick = clearLines;

  // =========================
  // DÉTECTION : ligne la plus proche
  // =========================

  function distance(a, b) {
    return Math.sqrt(
      Math.pow(a[0] - b[0], 2) +
      Math.pow(a[1] - b[1], 2)
    );
  }

  function lignesProchesDuClic(lat, lng, maxDist = 0.003) {
    const result = [];

    lignesSTM.forEach(ligne => {
      for (let p of ligne.coords) {
        if (distance([lat, lng], p) < maxDist) {
          result.push(ligne);
          break;
        }
      }
    });

    return result;
  }

  // =========================
  // CLIC SUR CARTE
  // =========================

  map.on("click", (e) => {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    clearLines();

    const lignes = lignesProchesDuClic(lat, lng);

    lignes.forEach(ligne => {
      const poly = L.polyline(ligne.coords, {
        color: ligne.color,
        weight: 5
      }).addTo(map);
      displayedLines.push(poly);
    });

    const texte = lignes.length > 0
      ? lignes.map(l => l.num).join(", ")
      : "aucune ligne";

    L.popup()
      .setLatLng(e.latlng)
      .setContent(`<b>Lignes STM proches :</b> ${texte}`)
      .openOn(map);
  });

</script>
