<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détours STM</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
  >

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }

    /* Carte plein écran */
    #map {
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    /* Panneau flottant */
    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      z-index: 1000;
    }

    #clearBtn {
      background:#d9534f;
      color:white;
      padding:10px 15px;
      border:none;
      border-radius:6px;
      font-size:16px;
      cursor:pointer;
    }

    #clearBtn:hover {
      background:#c64541;
    }
  </style>
</head>

<body>

  <!-- Panneau UI (inutile pour la logique mais je le garde) -->
  <div id="panel">
    <label>Ligne bus :</label>
    <input id="ligne" type="text" value="">

    <br><br>

    <button id="clearBtn">Effacer tracés</button>

    <p style="margin-top:10px;">
      Clique sur la carte (sur une rue) :<br>
      → je trouve le <b>nom de la rue</b><br>
      → j’affiche les <b>lignes de bus</b> qui passent près de là (24, 185, 14 dans cette démo).
    </p>
  </div>

  <!-- Carte -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <script>
    // =========================
    // 1. Initialisation carte
    // =========================
    const map = L.map('map');

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // On commence centré sur Montréal
    map.setView([45.52, -73.55], 12);

    // =========================
    // 2. Définition de quelques lignes STM (démo)
    //    24, 185, 14 autour de Sherbrooke
    // =========================

    const ligne24 = [
      [45.49055, -73.58818], // Atwater
      [45.49366, -73.58156],
      [45.49722, -73.57539],
      [45.50369, -73.56845],
      [45.50743, -73.56506],
      [45.50901, -73.56292],
      [45.51061, -73.56072],
      [45.51224, -73.55853],
      [45.51390, -73.55641],
      [45.51515, -73.55476],
      [45.51650, -73.55308],
      [45.51828, -73.55078],
      [45.51966, -73.54898],
      [45.52119, -73.54700],
      [45.52255, -73.54527],
      [45.52420, -73.54320],
      [45.52601, -73.54090],
      [45.52740, -73.53899],
      [45.52900, -73.53686],
      [45.53110, -73.53400],
      [45.53320, -73.53120],
      [45.53525, -73.52841],
      [45.53730, -73.52562],
      [45.53940, -73.52277],
      [45.54140, -73.52010],
      [45.54355, -73.51700],
      [45.54610, -73.51320]  // Honoré-Beaugrand
    ];

    const ligne185 = [
      [45.52420, -73.54320], // Papineau
      [45.52390, -73.53500],
      [45.52360, -73.52800],
      [45.52330, -73.52100],
      [45.52310, -73.51400],
      [45.52290, -73.50700],
      [45.52270, -73.50000],
      [45.52250, -73.49300],
      [45.52230, -73.48600],
      [45.52210, -73.47900]
    ];

    const ligne14 = [
      [45.5210, -73.5601], // Amherst / Sherbrooke
      [45.5187, -73.5614],
      [45.5170, -73.5630],
      [45.5157, -73.5644],
      [45.5143, -73.5659]
    ];

    const lignesSTM = [
      { num: "24", name: "Ligne 24 - Sherbrooke", color: "blue",  coords: ligne24 },
      { num: "185", name: "Ligne 185 - Sherbrooke", color: "red",   coords: ligne185 },
      { num: "14", name: "Ligne 14 - Atateken",     color: "green", coords: ligne14 }
    ];

    // On garde les polylines affichées pour pouvoir les effacer
    let displayedLines = [];

    function clearLines() {
      displayedLines.forEach(l => map.removeLayer(l));
      displayedLines = [];
    }

    document.getElementById("clearBtn").addEventListener("click", () => {
      clearLines();
      map.closePopup();
    });

    // =========================
    // 3. Chercher le nom de la rue avec Overpass (OpenStreetMap)
    // =========================
    async function getStreetName(lat, lng) {
      const query = `
        [out:json];
        way(around:20, ${lat}, ${lng})["highway"];
        out tags;
      `;
      try {
        const res = await fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: query
        });
        const json = await res.json();
        if (json.elements && json.elements.length > 0) {
          return json.elements[0].tags.name || "Rue inconnue";
        }
      } catch (err) {
        console.error(err);
      }
      return "Rue inconnue";
    }

    // =========================
    // 4. Lignes proches d’un point cliqué
    //    (maxDist ≈ 0.001 ≈ ~100 m)
    // =========================
    function lignesProches(lat, lng, maxDist = 0.001) {
      const result = [];

      lignesSTM.forEach(ligne => {
        for (let i = 0; i < ligne.coords.length; i++) {
          const p = ligne.coords[i];
          const dlat = Math.abs(p[0] - lat);
          const dlng = Math.abs(p[1] - lng);
          if (dlat < maxDist && dlng < maxDist) {
            result.push(ligne);
            break;
          }
        }
      });

      return result;
    }

    // =========================
    // 5. Gestion du clic sur la carte
    // =========================
    map.on("click", async (e) => {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      clearLines();

      // Popup "chargement"
      const loadingPopup = L.popup()
        .setLatLng(e.latlng)
        .setContent("Recherche de la rue et des lignes STM…")
        .openOn(map);

      const rue = await getStreetName(lat, lng);
      const lignes = lignesProches(lat, lng);

      // Afficher les lignes trouvées
      lignes.forEach(ligne => {
        const poly = L.polyline(ligne.coords, {
          color: ligne.color,
          weight: 5,
          opacity: 0.9
        }).addTo(map);
        displayedLines.push(poly);
      });

      const texteLignes = lignes.length > 0
        ? lignes.map(l => l.num).join(", ")
        : "aucune (dans cette démo)";

      loadingPopup.setContent(
        `<b>Rue :</b> ${rue}<br>` +
        `<b>Lignes STM :</b> ${texteLignes}`
      );
    });
  </script>

</body>
</html>
