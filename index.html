<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DÃ©tours STM â€“ Rue + lignes STM</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ðŸ”¥ FIX MOBILE OBLIGATOIRE POUR VOIR LA CARTE */
    html, body {
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
    }

    body {
      overflow: hidden; /* empÃªche le scroll qui casse Leaflet */
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100%;
      width: 100%;
      background: #ddd;
      z-index: 1;
    }

    #panel {
      position: absolute;
      z-index: 9999;
      top: 10px;
      left: 10px;
      right: 10px;
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      font-family: system-ui, sans-serif;
      font-size: 14px;
    }

    #status {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>

<body>

<div id="panel">
  ðŸ‘‰ Clique une rue : jâ€™affiche la rue EXACTE + les lignes STM associÃ©es.
  <div id="status"></div>
</div>

<div id="map"></div>

<script>
/* ============================================================
   1) INITIALISATION DE LA CARTE
   ============================================================ */

const map = L.map("map").setView([45.508, -73.587], 13);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const statusDiv = document.getElementById("status");
function setStatus(msg) { statusDiv.textContent = msg || ""; }

/* ============================================================
   2) DESSIN DES SEGMENTS
   ============================================================ */

let activePolylines = [];

function clearLines() {
  activePolylines.forEach(p => map.removeLayer(p));
  activePolylines = [];
}

function drawSegments(segments) {
  clearLines();
  segments.forEach(seg => {
    if (!seg.geometry || seg.geometry.length < 2) return;

    const coords = seg.geometry.map(pt => [pt.lat, pt.lon]);
    const poly = L.polyline(coords, {
      color: "#8a2be2",
      weight: 6
    }).addTo(map);

    activePolylines.push(poly);
  });
}

/* ============================================================
   3) REQUÃŠTES OVERPASS
   ============================================================ */

const OVERPASS = "https://overpass-api.de/api/interpreter";

async function queryOverpass(q) {
  const res = await fetch(OVERPASS, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: q
  });
  return await res.json();
}

async function getStreetName(lat, lng) {
  const q = `
    [out:json];
    way(around:20, ${lat}, ${lng})["highway"]["name"];
    out tags;
  `;
  const j = await queryOverpass(q);
  return j.elements?.[0]?.tags?.name || null;
}

async function getStreetSegments(name, lat, lng) {
  const q = `
    [out:json];
    way(around:250, ${lat}, ${lng})["name"="${name}"]["highway"];
    out geom;
  `;
  const j = await queryOverpass(q);
  return j.elements || [];
}

async function getStmLines(segments) {
  if (!segments.length) return [];

  const selectors = segments
    .map(s => `rel(bw:${s.id})["route"="bus"]["network"~"STM"];`)
    .join("\n");

  const q = `
    [out:json];
    (${selectors});
    out tags;
  `;

  const j = await queryOverpass(q);

  const refs = new Set();

  j.elements?.forEach(rel => {
    const v = rel.tags?.ref;
    if (!v) return;
    v.split(/[,\|]/).map(x => x.trim()).forEach(x => refs.add(x));
  });

  return [...refs].sort((a,b)=>parseInt(a)-parseInt(b));
}

/* ============================================================
   4) CLIC SUR LA CARTE
   ============================================================ */

map.on("click", async e => {
  const { lat, lng } = e.latlng;

  const popup = L.popup()
    .setLatLng(e.latlng)
    .setContent("Rechercheâ€¦")
    .openOn(map);

  setStatus("Recherche de la rueâ€¦");

  const name = await getStreetName(lat, lng);

  if (!name) {
    popup.setContent("Aucune rue trouvÃ©e ici.");
    return;
  }

  setStatus(`Rue trouvÃ©e : ${name} â€“ chargement des segmentsâ€¦`);

  const segments = await getStreetSegments(name, lat, lng);
  drawSegments(segments);

  setStatus(`Rue trouvÃ©e : ${name} â€“ dÃ©tection des lignes STMâ€¦`);

  const lines = await getStmLines(segments);

  popup.setContent(
    `<b>Rue :</b> ${name}<br>` +
    `<b>Lignes STM :</b> ${lines.length ? lines.join(", ") : "aucune"}`
  );

  setStatus(`Rue ${name} â€“ Lignes STM : ${lines.join(", ") || "Aucune"}`);
});
