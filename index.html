<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DÃ©tours STM â€“ DÃ©mo rues</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }

    #map {
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      z-index: 1000;
    }

    #clearBtn {
      background:#d9534f;
      color:white;
      padding:10px 15px;
      border:none;
      border-radius:6px;
      font-size:16px;
      cursor:pointer;
    }

    #clearBtn:hover {
      background:#c64541;
    }
  </style>
</head>

<body>

  <div id="panel">
    <label>Ligne bus :</label>
    <input id="ligne" type="text" placeholder="(facultatif)">

    <br><br>

    <button id="clearBtn">Effacer tracÃ©s</button>

    <p style="margin-top:10px;">
      ðŸ‘‰ Clique sur une rue.<br>
      â€¢ Si câ€™est <b>Rue Sherbrooke Ouest</b> ou <b>Rue Sherbrooke Est</b>,<br>
      &nbsp;&nbsp;â†’ jâ€™affiche les lignes de bus connues qui passent par lÃ .<br>
      â€¢ Sinon : aucun tracÃ© (dÃ©mo).
    </p>
  </div>

  <div id="map"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <script>
    // ================== 1. CARTE ==================
    const map = L.map('map');
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);
    map.setView([45.51, -73.58], 12); // MontrÃ©al

    let displayedLines = [];
    function clearLines() {
      displayedLines.forEach(l => map.removeLayer(l));
      displayedLines = [];
    }
    document.getElementById("clearBtn").onclick = clearLines;

    // ================== 2. LIGNES PAR RUE (DEMO) ==================
    const streetLines = {
      "Rue Sherbrooke Ouest": ["24", "105", "138", "356"],
      "Rue Sherbrooke Est":  ["24", "125", "185", "356"]
    };

    const lineColors = {
      "24":  "blue",
      "105": "red",
      "138": "green",
      "356": "purple",
      "125": "orange",
      "185": "brown"
    };

    // ================== 3. NOM DE RUE VIA OVERPASS ==================
    async function getStreetName(lat, lng) {
      const query = `
        [out:json];
        way(around:20, ${lat}, ${lng})["highway"];
        out tags;
      `;
      try {
        const res = await fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: query
        });
        const json = await res.json();
        if (json.elements && json.elements.length > 0) {
          return json.elements[0].tags.name || "Rue inconnue";
        }
      } catch (e) {
        console.error(e);
      }
      return "Rue inconnue";
    }

    // ================== 4. TRACER LIGNES ==================
    function drawLinesForStreet(streetName, lat, lng) {
      clearLines();

      const name = streetName.trim();
      const filt = document.getElementById("ligne").value.trim();

      const lignes = streetLines[name] || [];

      const lignesFiltrees = filt
        ? lignes.filter(n => n === filt)
        : lignes;

      if (lignesFiltrees.length === 0) return lignes;

      const lonDelta = 0.01;
      const latDelta = 0.0005;

      lignesFiltrees.forEach(num => {
        const col = lineColors[num] || "#0072bc";
        const coords = [
          [lat - latDelta, lng - lonDelta],
          [lat,            lng],
          [lat + latDelta, lng + lonDelta]
        ];
        const poly = L.polyline(coords, {
          color: col,
          weight: 5,
          opacity: 0.9
        }).addTo(map);
        displayedLines.push(poly);
      });

      return lignesFiltrees;
    }

    // ================== 5. CLIC SUR LA CARTE ==================
    map.on("click", async (e) => {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      const loadingPopup = L.popup()
        .setLatLng(e.latlng)
        .setContent("Recherche de la rueâ€¦")
        .openOn(map);

      const street = await getStreetName(lat, lng);
      const lignesActives = drawLinesForStreet(street, lat, lng);

      const txtLignes = (lignesActives && lignesActives.length > 0)
        ? lignesActives.join(", ")
        : "aucune (pour cette rue dans cette dÃ©mo)";

      loadingPopup.setContent(
        `<b>Rue :</b> ${street}<br>` +
        `<b>Lignes STM :</b> ${txtLignes}`
      );
    });
  </script>

</body>
</html>
