<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Détours STM</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #panel {
      background: white;
      padding: 10px;
      font-size: 16px;
      border-bottom: 2px solid #ccc;
    }

    #map {
      width: 100%;
      height: calc(100vh - 90px); /* panneau ≈ 90px */
    }

    input {
      font-size: 16px;
      padding: 4px 6px;
    }

    button {
      background: #ff4444;
      color: white;
      padding: 6px 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      margin-left: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div id="panel">
    Ligne bus :
    <input id="bus" placeholder="Ex : 186">
    <button id="clearBtn">Effacer détour</button>
    <br><br>
    1er clic sur la carte : <b>début du détour</b> – 2e clic : <b>fin du détour</b> → calcul du trajet
  </div>

  <div id="map"></div>

  <script>
    // ------------ CONFIG GRAPHOPPER ------------
    // TA CLÉ API DIRECTEMENT ICI (pas besoin de la remettre à chaque fois)
    const API_KEY = "1adf955d-015a-43ae-a58b-0e3c04d6a8d4";

    // ------------ DECODEUR DE POLYLINE (comme quand ça marchait) ------------
    function decodePolyline(encoded) {
      let coords = [];
      let index = 0, lat = 0, lng = 0;

      while (index < encoded.length) {
        let b, shift = 0, result = 0;

        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);

        let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
        lat += dlat;

        shift = 0;
        result = 0;

        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);

        let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
        lng += dlng;

        coords.push([lat / 1e5, lng / 1e5]);
      }

      return coords;
    }

    // ------------ INITIALISATION DE LA CARTE ------------
    const map = L.map("map").setView([45.55, -73.55], 14);

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    // ------------ VARIABLES D'ÉTAT ------------
    let click1 = null;
    let click2 = null;
    let marker1 = null;
    let marker2 = null;
    let routeAvant = null;   // on ne gère qu’un seul détour pour l’instant

    // ------------ GESTION DU RESET ------------
    function resetDetour() {
      click1 = null;
      click2 = null;

      if (marker1) { map.removeLayer(marker1); marker1 = null; }
      if (marker2) { map.removeLayer(marker2); marker2 = null; }
      if (routeAvant) { map.removeLayer(routeAvant); routeAvant = null; }
    }

    document.getElementById("clearBtn").onclick = resetDetour;

    // ------------ CLICS SUR LA CARTE ------------
    map.on("click", async (e) => {
      // Premier clic : début du détour
      if (!click1) {
        click1 = e.latlng;
        marker1 = L.marker(click1).addTo(map);

        const bus = document.getElementById("bus").value.trim();
        if (bus) {
          marker1.bindPopup("Début du détour – ligne " + bus).openPopup();
        } else {
          marker1.bindPopup("Début du détour").openPopup();
        }
        return;
      }

      // Deuxième clic : fin du détour + calcul
      if (!click2) {
        click2 = e.latlng;
        marker2 = L.marker(click2).addTo(map);

        const bus = document.getElementById("bus").value.trim();
        if (bus) {
          marker2.bindPopup("Fin du détour – ligne " + bus).openPopup();
        } else {
          marker2.bindPopup("Fin du détour").openPopup();
        }

        await calculDetour(); // on lance le calcul
      }
    });

    // ------------ APPEL À GRAPHHOPPER (GET, MODE CH) ------------
    async function calculDetour() {
      if (!click1 || !click2) return;

      // Construction de l’URL comme quand ça marchait
      let url =
        "https://graphhopper.com/api/1/route?" +
        "key=" + API_KEY +
        "&profile=car" +
        "&locale=fr" +
        "&points_encoded=true" +   // on reçoit un polyline encodé
        "&instructions=false";

      // IMPORTANT : ordre lat,lon (et pas l’inverse)
      url += `&point=${click1.lat},${click1.lng}`;
      url += `&point=${click2.lat},${click2.lng}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.paths || !data.paths[0]) {
          alert("Aucun chemin trouvé pour ce détour.");
          console.log("Réponse GraphHopper:", data);
          return;
        }

        const coords = decodePolyline(data.paths[0].points);

        // On efface l’ancien tracé
        if (routeAvant) {
          map.removeLayer(routeAvant);
        }

        // Trace du détour en rouge
        routeAvant = L.polyline(coords, { weight: 5, color: "red" }).addTo(map);
        map.fitBounds(routeAvant.getBounds());

      } catch (err) {
        console.error(err);
        alert("Erreur lors de l'appel à GraphHopper.");
      }
    }
  </script>

</body>
</html>
