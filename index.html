async function loadRoute(ref){
    const q=`
    [out:json][timeout:60];
    (
        relation["route"="bus"]["network"="STM"]["ref"="${ref}"];
        relation["route"="bus"]["network"="STM"]["ref:STM"="${ref}"];
        relation["route"="bus"]["network"="STM"]["name"~"(^| )${ref}( |$)"];
    );
    (._;>;);
    out body;
    `;

    const res=await fetch("https://overpass-api.de/api/interpreter",{
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body:"data="+encodeURIComponent(q)
    });
    const d=await res.json();

    if (!d.elements.length) return alert("❌ Ligne introuvable dans OSM/Overpass");

    const ways=d.elements.filter(e=>e.type==="way");
    const nodes=d.elements.filter(e=>e.type==="node");
    const rels=d.elements.filter(e=>e.type==="relation");

    const routeLayer = L.layerGroup().addTo(map);
    if(window.routeLayer) map.removeLayer(window.routeLayer);
    window.routeLayer = routeLayer;

    ways.forEach(w=>{
        if(w.geometry)
            L.polyline(w.geometry.map(p=>[p.lat,p.lon]),{color:"#0F9D58",weight:5}).addTo(routeLayer);
    });

    const nodeMap=new Map(nodes.map(n=>[n.id,n]));
    const stops=[];
    rels[0].members.forEach(m=>{
        if(m.type==="node"){
            const n=nodeMap.get(m.ref);
            if(n?.tags?.highway==="bus_stop") stops.push(n.tags.name||"Arrêt");
        }
    });

    show(`
        <h2>Ligne ${ref}</h2>
        <h3>Arrêts (ordre réel du trajet) :</h3>
        <ol>${stops.map(s=>`<li>${s}</li>`).join("")}</ol>
    `);
}
