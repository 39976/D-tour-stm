<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détours STM – Cliquer sur la carte</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin:0; padding:0; }
        #map { height:100vh; width:100vw; }

        #floating-actions {
            position: fixed;
            bottom: 25px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 9999;
        }

        .fab {
            background: white;
            padding: 12px 18px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .fab-red {
            background: #ff4d4d;
            color: white;
        }
    </style>
</head>

<body>

<div id="map"></div>

<div id="floating-actions">
    <button class="fab" id="avantBtn">Avant</button>
    <button class="fab fab-red" id="apresBtn">Après</button>
</div>

<script>

const API_KEY = "1adf955d-015a-43ae-a58b-0e3c04d6a8d4"; // TA CLÉ

// --- Decode Polyline ---
function decodePolyline(encoded) {
    let coords = [];
    let index = 0, lat = 0, lng = 0;

    while (index < encoded.length) {
        let b, shift = 0, result = 0;
        do {
            b = encoded.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);
        let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
        lat += dlat;

        shift = 0;
        result = 0;
        do {
            b = encoded.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);
        let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
        lng += dlng;

        coords.push([lat / 1e5, lng / 1e5]);
    }
    return coords;
}

// --- ROUTING FUNCTION ---
async function getRoute(points) {

    let url = "https://graphhopper.com/api/1/route?";
    url += "key=" + API_KEY;
    url += "&profile=car";
    url += "&locale=fr";
    url += "&points_encoded=true";
    url += "&instructions=false";

    points.forEach(p => {
        url += `&point=${p.lat},${p.lng}`;
    });

    const res = await fetch(url);
    const data = await res.json();

    if (!data.paths || !data.paths[0]) {
        alert("Aucun chemin trouvé");
        return null;
    }

    return decodePolyline(data.paths[0].points);
}

// --- LEAFLET MAP ---
let map = L.map("map").setView([45.51, -73.56], 13);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

let startMarker = null;
let endMarker = null;
let start = null;
let end = null;

let routeAvant = null;
let routeApres = null;

// --- CLICK HANDLER ---
map.on("click", (e) => {
    if (!start) {
        start = e.latlng;
        startMarker = L.marker(start, {color:"green"}).addTo(map);
    } 
    else if (!end) {
        end = e.latlng;
        endMarker = L.marker(end, {color:"red"}).addTo(map);
    } 
    else {
        alert("2 points déjà définis.\nRecharge la page pour recommencer.");
    }
});

// --- AVANT ---
document.getElementById("avantBtn").onclick = async () => {
    if (!start || !end) { alert("Tape 2 points sur la carte d'abord !"); return; }

    if (routeAvant) map.removeLayer(routeAvant);

    const coords = await getRoute([ start, end ]);
    if (!coords) return;

    routeAvant = L.polyline(coords, { color: "blue", weight: 4 }).addTo(map);
    map.fitBounds(routeAvant.getBounds());
};

// --- APRES ---
document.getElementById("apresBtn").onclick = async () => {
    if (!start || !end) { alert("Tape 2 points sur la carte d'abord !"); return; }

    if (routeApres) map.removeLayer(routeApres);

    const coords = await getRoute([ start, end ]);
    if (!coords) return;

    routeApres = L.polyline(coords, { color: "red", weight: 4 }).addTo(map);
    map.fitBounds(routeApres.getBounds());
};

</script>

</body>
</html>
