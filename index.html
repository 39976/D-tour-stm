<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { margin:0; padding:0; }
  #map { width:100%; height:90vh; }
  #panel {
      background:white;
      padding:10px;
      font-size:18px;
      border-bottom:2px solid #ccc;
  }
</style>
</head>

<body>

<div id="panel">
  Ligne bus : <input id="bus" placeholder="186">
  <button onclick="resetDetour()">Effacer détour</button>
  <br><br>
  1er clic = début de l’entrave — 2e clic = fin → calcul du détour
</div>

<div id="map"></div>

<script>

const API_KEY = "1adf955d-015a-43ae-a58b-0e3c04d6a8d4";

let map = L.map('map').setView([45.55, -73.55], 14);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let pt1 = null, pt2 = null;
let m1 = null, m2 = null;
let routeLine = null;

map.on("click", (e) => {
    if (!pt1) {
        pt1 = e.latlng;
        m1 = L.marker(pt1).addTo(map);
        return;
    }
    if (!pt2) {
        pt2 = e.latlng;
        m2 = L.marker(pt2).addTo(map);
        calculDetour();
    }
});

function resetDetour() {
    pt1 = pt2 = null;
    if (m1) map.removeLayer(m1);
    if (m2) map.removeLayer(m2);
    if (routeLine) map.removeLayer(routeLine);
}

// -------------------------------------
//      CALCUL DU DÉTOUR (IMPORTANT)
// -------------------------------------
async function calculDetour() {

    const block = {
        type: "LineString",
        coordinates: [
            [pt1.lng, pt1.lat],
            [pt2.lng, pt2.lat]
        ]
    };

    const body = {
        profile: "car",
        points: [
            [pt1.lng, pt1.lat],
            [pt2.lng, pt2.lat]
        ],
        block_areas: [ block ]
    };

    const url = `https://graphhopper.com/api/1/route?key=${API_KEY}`;

    const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    const data = await response.json();

    if (!data.paths || data.paths.length === 0) {
        alert("Aucun chemin trouvé");
        return;
    }

    const pts = data.paths[0].points.coordinates.map(p => [p[1], p[0]]);
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(pts, {color:"red", weight:5}).addTo(map);

    map.fitBounds(routeLine.getBounds());
}

</script>

</body>
</html>
