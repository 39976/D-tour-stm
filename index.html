<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détours STM – FIXED</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        #floating-actions {
            position: fixed;
            bottom: 25px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 9999;
        }

        .fab {
            background: white;
            padding: 12px 18px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .fab-red {
            background: #ff4d4d;
            color: white;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div id="floating-actions">
        <button class="fab" id="avantBtn">Avant</button>
        <button class="fab fab-red" id="apresBtn">Après</button>
    </div>

    <script>
        function decodePolyline(encoded) {
            let coords = [];
            let index = 0, lat = 0, lng = 0;

            while (index < encoded.length) {
                let b, shift = 0, result = 0;

                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);

                let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
                lat += dlat;

                shift = 0;
                result = 0;

                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);

                let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
                lng += dlng;

                coords.push([lat / 1e5, lng / 1e5]);
            }

            return coords;
        }

        /* ⭐ TA CLÉ API ⭐ */
        const API_KEY = "87a97ff3-8371-4f51-a54d-79f0d8f9fa48";

        async function getRoute(points) {
            let url =
                "https://graphhopper.com/api/1/route?" +
                "key=" + API_KEY +
                "&vehicle=car" +
                "&profile=car" +               /* ⭐ OBLIGATOIRE pour éviter "Aucun chemin" */
                "&locale=fr" +
                "&points_encoded=true" +
                "&instructions=false" +
                "&ch.disable=true";

            points.forEach(p => {
                url += `&point=${p.lat},${p.lng}`;
            });

            const res = await fetch(url);
            const data = await res.json();

            if (!data.paths || !data.paths[0]) {
                alert("Aucun chemin trouvé");
                console.log("Réponse GraphHopper :", data);
                return null;
            }

            return decodePolyline(data.paths[0].points);
        }

        let map = L.map("map").setView([45.5017, -73.5673], 13);

        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19
        }).addTo(map);

        let routeAvant = null;
        let routeApres = null;

        const start = { lat: 45.501, lng: -73.567 };
        const end   = { lat: 45.515, lng: -73.56 };

        document.getElementById("avantBtn").onclick = async () => {
            if (routeAvant) map.removeLayer(routeAvant);

            const coords = await getRoute([start, end]);
            if (!coords) return;

            routeAvant = L.polyline(coords, { color: "blue", weight: 4 }).addTo(map);
            map.fitBounds(routeAvant.getBounds());
        };

        document.getElementById("apresBtn").onclick = async () => {
            if (routeApres) map.removeLayer(routeApres);

            const coords = await getRoute([start, end]);
            if (!coords) return;

            routeApres = L.polyline(coords, { color: "red", weight: 4 }).addTo(map);
            map.fitBounds(routeApres.getBounds());
        };
    </script>

</body>
</html>
