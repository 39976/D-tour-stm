
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>STM â€“ Rues, Lignes & ArrÃªts</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
    }
    #map {
        width: 100%;
        height: 100%;
    }

    .leaflet-popup-content {
        font-size: 15px;
        font-family: Arial, sans-serif;
        line-height: 1.45;
    }
    .popup-title {
        font-weight: bold;
        font-size: 17px;
        margin-bottom: 4px;
    }
    .popup-hors-stm {
        color: #d93025;
        font-weight: bold;
    }

    /* Boutons custom Leaflet (mode sombre, GPS) */
    .leaflet-control-custom {
        background: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        cursor: pointer;
    }
    .leaflet-control-custom button {
        border: none;
        background: transparent;
        padding: 6px 8px;
        font-size: 14px;
        font-family: Arial, sans-serif;
    }
    .leaflet-control-custom button:active {
        background: #e0e0e0;
    }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ====================================================================
//  MAP INIT (with light + dark layers)
// ====================================================================
const lightTiles = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap",
    maxZoom: 22,
    maxNativeZoom: 19
});

const darkTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    attribution: "&copy; OpenStreetMap, Â© CARTO",
    maxZoom: 22,
    maxNativeZoom: 19
});

const map = L.map("map", {
    zoomControl: true,
    minZoom: 3,
    maxZoom: 22,
    layers: [lightTiles]
}).setView([45.55, -73.65], 14);


// ====================================================================
//  ICÃ”NE STM
// ====================================================================
const stmIcon = L.icon({
    iconUrl: "https://i.imgur.com/IIZOOia.png",
    iconSize: [38, 38],
    iconAnchor: [19, 38],
    popupAnchor: [0, -35]
});


// ====================================================================
// 1) CLIQUER SUR UNE RUE â†’ LIGNES STM
// ====================================================================
let rueLayer = null;
let ligneLayer = null;      // tracÃ©s liÃ©s au clic sur la rue
let stopRouteLayer = null;  // tracÃ©s liÃ©s au clic sur un arrÃªt

map.on("click", async (e) => {

    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    // ---- 1) Rue exacte autour du clic ----
    const queryRue = `
    [out:json][timeout:25];
    way(around:10, ${lat}, ${lon})["highway"];
    out geom;
    `;

    const resRue = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: queryRue
    });

    const dataRue = await resRue.json();
    if (!dataRue.elements.length) return;

    const rue = dataRue.elements[0];

    if (rueLayer) map.removeLayer(rueLayer);
    rueLayer = L.polyline(rue.geometry.map(pt => [pt.lat, pt.lon]), {
        color: "#1A73E8",
        weight: 10,
        opacity: 0.85
    }).addTo(map);

    map.panTo([lat, lon]);

    // ---- 2) Lignes STM proches de ce point (around) ----
    const queryLignes = `
    [out:json][timeout:40];
    rel["route"="bus"]["network"="STM"](around:50, ${lat}, ${lon});
    out body;
    >;
    out geom;
    `;

    const resLignes = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: queryLignes
    });

    const dataLignes = await resLignes.json();

    const refs = [...new Set(
        dataLignes.elements
            .filter(el => el.type === "relation")
            .map(el => el.tags.ref)
    )];

    const hasLines = refs.length > 0;

    rueLayer.bindPopup(`
        <div class="popup-title">${rue.tags.name || "Rue inconnue"}</div>
        <b>Lignes STM :</b><br>
        ${
            hasLines
            ? refs.map(r => "â€¢ " + r).join("<br>")
            : '<span class="popup-hors-stm">Aucun service STM ici (hors territoire STM)</span>'
        }
    `).openPopup();

    // ---- 3) Tracer les lignes STM trouvÃ©es ----
    if (ligneLayer) map.removeLayer(ligneLayer);
    ligneLayer = L.layerGroup();

    const ways = dataLignes.elements.filter(el => el.type === "way");
    const colors = ["#DB4437","#0F9D58","#F4B400","#00A7E1","#A142F4"];

    ways.forEach((w, i) => {
        if (!w.geometry) return;
        L.polyline(w.geometry.map(p => [p.lat, p.lon]), {
            color: colors[i % colors.length],
            weight: 6,
            opacity: 0.85
        }).addTo(ligneLayer);
    });

    ligneLayer.addTo(map);

    // On efface les tracÃ©s liÃ©s au dernier arrÃªt cliquÃ©
    if (stopRouteLayer) {
        map.removeLayer(stopRouteLayer);
        stopRouteLayer = null;
    }
});


// ====================================================================
// 2) ARRÃŠTS STM
// ====================================================================
async function STMStops_load() {

    const query = `
    [out:json][timeout:35];
    (
      node["highway"="bus_stop"]["operator"="STM"](area:3600065600);
      node["highway"="bus_stop"]["network"="STM"](area:3600065600);
    );
    out body;
    `;

    const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    });

    const data = await res.json();

    data.elements.forEach(stop => {

        const marker = L.marker([stop.lat, stop.lon], {
            icon: stmIcon
        }).addTo(map);

        marker.on("click", () => STMStops_showInfo(stop, marker));
    });
}


// ====================================================================
// 3) POPUP + TRAJETS COMPLETS Dâ€™UN ARRÃŠT STM
// ====================================================================
async function STMStops_showInfo(stop, marker) {

    const q = `
    [out:json][timeout:40];
    rel["route"="bus"]["network"="STM"](around:40, ${stop.lat}, ${stop.lon});
    out body;
    >;
    out geom;
    `;

    const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: q
    });

    const data = await res.json();

    const relations = data.elements.filter(el => el.type === "relation");
    const ways = data.elements.filter(el => el.type === "way");

    const lignes = relations.map(rel => {
        const ref = rel.tags.ref || "?";
        const dir = rel.tags.direction || rel.tags.to || "";
        return dir ? `${ref} â†’ ${dir}` : ref;
    });

    const hasLines = lignes.length > 0;

    const stopId =
        stop.tags["ref:STM"] ||
        stop.tags["ref:stop_id"] ||
        stop.tags.ref ||
        stop.id;

    marker.bindPopup(`
        <div class="popup-title">${stop.tags.name || "ArrÃªt STM"}</div>
        <b>ID STM :</b> ${stopId}<br>
        <b>Lignes :</b><br>
        ${
            hasLines
            ? lignes.map(l => "â€¢ " + l).join("<br>")
            : '<span class="popup-hors-stm">Aucun service STM ici (hors territoire STM)</span>'
        }
    `).openPopup();

    map.panTo([stop.lat, stop.lon]);

    // --- Tracer les trajets complets des lignes trouvÃ©es ---
    if (stopRouteLayer) map.removeLayer(stopRouteLayer);
    stopRouteLayer = L.layerGroup();

    const colors = ["#DB4437","#0F9D58","#F4B400","#00A7E1","#A142F4"];

    ways.forEach((w, i) => {
        if (!w.geometry) return;
        L.polyline(w.geometry.map(p => [p.lat, p.lon]), {
            color: colors[i % colors.length],
            weight: 5,
            opacity: 0.8,
            dashArray: "4,4"
        }).addTo(stopRouteLayer);
    });

    stopRouteLayer.addTo(map);
}


// Charger les arrÃªts STM
STMStops_load();


// ====================================================================
// 4) BOUTON MODE SOMBRE / CLAIR
// ====================================================================
let isDark = false;

const DarkControl = L.Control.extend({
    options: { position: "topright" },
    onAdd: function(map) {
        const container = L.DomUtil.create("div", "leaflet-control-custom");
        const btn = L.DomUtil.create("button", "", container);
        btn.innerText = "Mode sombre";

        L.DomEvent.on(btn, "click", (e) => {
            L.DomEvent.stopPropagation(e);
            if (isDark) {
                map.removeLayer(darkTiles);
                map.addLayer(lightTiles);
                btn.innerText = "Mode sombre";
                isDark = false;
            } else {
                map.removeLayer(lightTiles);
                map.addLayer(darkTiles);
                btn.innerText = "Mode clair";
                isDark = true;
            }
        });

        return container;
    }
});
map.addControl(new DarkControl());


// ====================================================================
// 5) BOUTON GPS "ME CENTRER"
// ====================================================================
const LocateControl = L.Control.extend({
    options: { position: "bottomright" },
    onAdd: function(map) {
        const container = L.DomUtil.create("div", "leaflet-control-custom");
        const btn = L.DomUtil.create("button", "", container);
        btn.innerText = "ðŸ“ Moi";

        L.DomEvent.on(btn, "click", (e) => {
            L.DomEvent.stopPropagation(e);
            if (!navigator.geolocation) {
                alert("La gÃ©olocalisation n'est pas supportÃ©e.");
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    map.setView([lat, lon], 16);
                },
                () => {
                    alert("Impossible de rÃ©cupÃ©rer ta position.");
                }
            );
        });

        return container;
    }
});
map.addControl(new LocateControl());

</script>
</body>
</html>
