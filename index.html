
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Détours STM</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    font-family: Arial;
}
#map {
    width: 100vw;
    height: 100vh;
}
#panel {
    position: fixed;
    top: 10px;
    left: 10px;
    background: white;
    padding: 10px;
    border-radius: 10px;
    z-index: 2000;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
}
button {
    padding: 8px 14px;
    margin-left: 8px;
    border-radius: 8px;
    border: none;
}
</style>

</head>
<body>

<div id="panel">
    <label>Ligne bus :</label>
    <input id="busLine" placeholder="186">
    <button onclick="clearDetour()">Effacer détour</button>
    <p>1er clic : début de l'entrave<br>2e clic : fin de l'entrave → calcul</p>
</div>

<div id="map"></div>

<script>
const API_KEY = "1adf955d-015a-43ae-a58b-0e3c04d6a8d4";  // ✔ intégrée

let map = L.map("map").setView([45.55, -73.6], 13);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let markers = [];
let polyline = null;

function decodePolyline(str) {
    let coords = [];
    let index = 0, lat = 0, lng = 0;

    while (index < str.length) {
        let b, shift = 0, result = 0;
        do {
            b = str.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);
        let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
        lat += dlat;

        shift = 0;
        result = 0;
        do {
            b = str.charCodeAt(index++) - 63;
            result |= (b & 0x1f) << shift;
            shift += 5;
        } while (b >= 0x20);
        let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
        lng += dlng;

        coords.push([lat / 1e5, lng / 1e5]);
    }
    return coords;
}

async function calcRoute(p1, p2) {
    const url =
        `https://graphhopper.com/api/1/route?key=${API_KEY}` +
        `&vehicle=car&points_encoded=true&instructions=false` +
        `&point=${p1.lat},${p1.lng}&point=${p2.lat},${p2.lng}`;

    const res = await fetch(url);
    const data = await res.json();

    if (!data.paths || !data.paths[0]) {
        alert("Aucun chemin trouvé pour ce détour");
        return null;
    }

    return decodePolyline(data.paths[0].points);
}

map.on("click", async e => {
    markers.push(L.marker(e.latlng).addTo(map));

    if (markers.length === 2) {
        const start = markers[0].getLatLng();
        const end   = markers[1].getLatLng();

        const coords = await calcRoute(start, end);
        if (!coords) return;

        if (polyline) map.removeLayer(polyline);

        polyline = L.polyline(coords, {color: "red", weight: 4}).addTo(map);
        map.fitBounds(polyline.getBounds());
    }
});

function clearDetour() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    if (polyline) map.removeLayer(polyline);
}

</script>

</body>
</html>
