<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>STM â€“ Rues, Lignes & ArrÃªts</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
    }
    #map {
        width: 100%;
        height: 100%;
    }

    .leaflet-popup-content {
        font-size: 15px;
        font-family: Arial, sans-serif;
        line-height: 1.45;
    }
    .popup-title {
        font-weight: bold;
        font-size: 17px;
        margin-bottom: 4px;
    }
    .popup-hors-stm {
        color: #d93025;
        font-weight: bold;
    }

    /* ðŸŒŸ Popup gigantifiÃ©e sur tÃ©lÃ©phone */
    @media (max-width: 900px) {
        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            transform: scale(1.8);
            transform-origin: top left;
        }

        .leaflet-popup-content {
            font-size: 18px !important;
            line-height: 1.55;
        }
    }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ====================================================================
//  MAP INIT (light + dark)
// ====================================================================
const lightTiles = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap",
    maxZoom: 22,
    maxNativeZoom: 19
});

const darkTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    attribution: "&copy; OpenStreetMap, Â© CARTO",
    maxZoom: 22,
    maxNativeZoom: 19
});

const map = L.map("map", {
    zoomControl: true,
    minZoom: 3,
    maxZoom: 22,
    layers: [lightTiles]
}).setView([45.55, -73.65], 14);


// ====================================================================
//  ICÃ”NE STM
// ====================================================================
const stmIcon = L.icon({
    iconUrl: "https://i.imgur.com/IIZOOia.png",
    iconSize: [38, 38],
    iconAnchor: [19, 38],
    popupAnchor: [0, -35]
});


// ====================================================================
// 1) CLIQUER SUR UNE RUE
// ====================================================================
let rueLayer = null;
let ligneLayer = null;
let stopRouteLayer = null;

map.on("click", async (e) => {

    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    // ---- Rue exacte ----
    const queryRue = `
    [out:json][timeout:25];
    way(around:10, ${lat}, ${lon})["highway"];
    out geom;
    `;

    const resRue = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: queryRue
    });

    const dataRue = await resRue.json();
    if (!dataRue.elements.length) return;

    const rue = dataRue.elements[0];

    if (rueLayer) map.removeLayer(rueLayer);

    rueLayer = L.polyline(rue.geometry.map(pt => [pt.lat, pt.lon]), {
        color: "#1A73E8",
        weight: 10,
        opacity: 0.85
    }).addTo(map);

    map.panTo([lat, lon]);

    // ---- Lignes STM proches ----
    const queryLignes = `
    [out:json][timeout:40];
    rel["route"="bus"]["network"="STM"](around:50, ${lat}, ${lon});
    out body;
    >;
    out geom;
    `;

    const resLignes = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: queryLignes
    });

    const dataLignes = await resLignes.json();

    const refs = [...new Set(
        dataLignes.elements
            .filter(el => el.type === "relation")
            .map(el => el.tags.ref)
    )];

    const hasLines = refs.length >
