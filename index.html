<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Détours STM – Version 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
    }
    #map {
      width: 100vw;
      height: 55vh;
    }
    .panel {
      background: #ffffff;
      padding: 14px;
    }
    .chip {
      display: inline-block;
      background: #e3f2fd;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      margin: 2px;
    }
    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #1976d2;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      margin-top: 12px;
    }
    button:disabled {
      background: #9e9e9e;
    }
    #steps {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="panel">
    <h2>Détours STM – v2.0</h2>
    <p>1️⃣ Clique pour le point AVANT<br>2️⃣ Clique pour le point APRÈS<br>3️⃣ Appuie sur « Calculer »</p>
    <div id="chips"></div>
    <button id="btnRoute" disabled>Calculer le détour</button>
    <button id="btnReset" style="background:#cccccc; color:#000;">Réinitialiser</button>
    <div id="status"></div>
  </div>

  <div id="map"></div>

  <div class="panel">
    <div id="steps"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    var map = L.map('map').setView([45.52, -73.57], 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    let start = null, end = null;
    let startMarker = null, endMarker = null;
    let routeLayer = null;

    const btnRoute = document.getElementById("btnRoute");
    const btnReset = document.getElementById("btnReset");
    const chips = document.getElementById("chips");
    const statusDiv = document.getElementById("status");
    const stepsDiv = document.getElementById("steps");

    // Fonction pour SNAPPER automatiquement sur la route la plus proche
    async function snapToRoad(lat, lng) {
      const url = `https://router.project-osrm.org/nearest/v1/driving/${lng},${lat}`;
      const res = await fetch(url);
      const data = await res.json();

      if (data && data.waypoints && data.waypoints.length > 0) {
        return {
          lat: data.waypoints[0].location[1],
          lng: data.waypoints[0].location[0]
        };
      }

      return { lat, lng }; // fallback
    }

    function updateChips() {
      chips.innerHTML = "";

      if (start)
        chips.innerHTML += `<span class="chip">AVANT : ${start.lat.toFixed(5)}, ${start.lng.toFixed(5)}</span>`;
      if (end)
        chips.innerHTML += `<span class="chip">APRÈS : ${end.lat.toFixed(5)}, ${end.lng.toFixed(5)}</span>`;

      btnRoute.disabled = !(start && end);
    }

    // Clic sur la carte
    map.on("click", async function (e) {
      const snapped = await snapToRoad(e.latlng.lat, e.latlng.lng);

      if (!start) {
        start = snapped;
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker(start).addTo(map);
      }
      else if (!end) {
        end = snapped;
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker(end).addTo(map);
      }
      else {
        // Reset auto si 3ème clic
        resetAll();
        start = snapped;
        startMarker = L.marker(start).addTo(map);
      }

      updateChips();
    });

    async function calculateRoute() {
      statusDiv.innerHTML = "Calcul du détour...";
      stepsDiv.innerHTML = "";

      let retries = [
        [start, end],
        // petites variantes en cas de sens unique
        [{ lat: start.lat+0.0001, lng: start.lng+0.0001 }, end],
        [{ lat: start.lat-0.0001, lng: start.lng-0.0001 }, end],
        [start, { lat: end.lat+0.0001, lng: end.lng+0.0001 }],
        [start, { lat: end.lat-0.0001, lng: end.lng-0.0001 }],
      ];

      for (let [s, e] of retries) {
        let url = `https://router.project-osrm.org/route/v1/driving/${s.lng},${s.lat};${e.lng},${e.lat}?overview=full&geometries=geojson&steps=true`;

        try {
          let res = await fetch(url);
          let data = await res.json();

          if (data.routes && data.routes.length > 0) {
            displayRoute(data.routes[0]);
            return;
          }
        } catch (err) {}
      }

      statusDiv.innerHTML = "<span style='color:red;'>Impossible de trouver un itinéraire valide.</span>";
    }

    function displayRoute(route) {
      statusDiv.innerHTML =
        `Distance : ${(route.distance/1000).toFixed(2)} km — Temps : ${Math.round(route.duration/60)} min`;

      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.geoJSON(route.geometry).addTo(map);

      map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });

      let html = `<h3>Instructions :</h3>`;
      route.legs[0].steps.forEach((s, i) => {
        html += `<div>${i+1}. ${s.maneuver.instruction}</div>`;
      });
      stepsDiv.innerHTML = html;
    }

    function resetAll() {
      start = null;
      end = null;
      if (startMarker) map.removeLayer(startMarker);
      if (endMarker) map.removeLayer(endMarker);
      if (routeLayer) map.removeLayer(routeLayer);

      stepsDiv.innerHTML = "";
      statusDiv.innerHTML = "";
      updateChips();
    }

    btnRoute.onclick = calculateRoute;
    btnReset.onclick = resetAll;
  </script>
</body>
</html>
