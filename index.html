<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body { margin:0; padding:0; }
    #map { width:100%; height:90vh; }
    #panel {
        background:white;
        padding:10px;
        font-size:18px;
        border-bottom:2px solid #ccc;
    }
</style>
</head>

<body>

<div id="panel">
    Ligne bus : <input id="bus" placeholder="186">
    <button onclick="resetDetour()">Effacer détour</button><br>
    1er clic = début — 2e clic = fin → détour automatique
</div>

<div id="map"></div>

<script>

const API_KEY = "1adf955d-015a-43ae-a58b-0e3c04d6a8d4";

let map = L.map('map').setView([45.55, -73.55], 15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
 { maxZoom: 20 }).addTo(map);

let p1=null, p2=null;
let m1=null, m2=null;
let line=null;

map.on("click", e => {
    if (!p1) {
        p1 = e.latlng;
        m1 = L.marker(p1).addTo(map);
    } else if (!p2) {
        p2 = e.latlng;
        m2 = L.marker(p2).addTo(map);
        calculDetour();
    }
});

function resetDetour() {
    p1=null; p2=null;
    if (m1) map.removeLayer(m1);
    if (m2) map.removeLayer(m2);
    if (line) map.removeLayer(line);
}

async function calculDetour() {

    // La "zone interdite" (l’entrave) → petit rectangle autour du segment
    const avoid = {
        type: "Polygon",
        coordinates: [[
            [p1.lng, p1.lat],
            [p2.lng, p2.lat],
            [p2.lng+0.0003, p2.lat+0.0003],
            [p1.lng+0.0003, p1.lat+0.0003],
            [p1.lng, p1.lat]
        ]]
    };

    let url = `https://graphhopper.com/api/1/route?key=${API_KEY}`;

    let body = {
        profile: "car",
        points: [
            [p1.lng, p1.lat],
            [p2.lng, p2.lat]
        ],
        avoid_polygons: avoid
    };

    let rep = await fetch(url, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
    });

    let data = await rep.json();

    if (!data.paths) {
        alert("Impossible de calculer un détour");
        return;
    }

    let pts = data.paths[0].points.coordinates.map(p=>[p[1],p[0]]);

    if (line) map.removeLayer(line);
    line = L.polyline(pts, {color:"red", weight:5}).addTo(map);
    map.fitBounds(line.getBounds());
}

</script>
</body>
</html>
