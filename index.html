<script>
const API_KEY = "87a97ff3-8371-4f51-a54d-79f0d8f9fa48";

let map = L.map("map").setView([45.52, -73.57], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let start = null, end = null;
let m1 = null, m2 = null, routeLayer = null;

// Snap sur route GRAPHOPPER (pas OSM)
async function snap(lat, lng) {
  const url =
    `https://graphhopper.com/api/1/route?point=${lat},${lng}&point=${lat+0.0001},${lng+0.0001}` +
    `&vehicle=car&key=${API_KEY}&locale=fr&point_hint=street`;

  let r = await (await fetch(url)).json();
  if (r.paths && r.paths[0] && r.paths[0].snapped_waypoints) {
    let p = r.paths[0].snapped_waypoints.coordinates[0];
    return { lat: p[1], lng: p[0] };
  }
  return { lat, lng };
}

// Calcul du rectangle parfaitement parallèle à la rue
function buildBlockArea(s, e) {
  let dx = e.lng - s.lng;
  let dy = e.lat - s.lat;

  let len = Math.sqrt(dx*dx + dy*dy);
  dx /= len;
  dy /= len;

  let w = 0.00020; // largeur 20m
  let l = 0.00010; // long côté

  let p1 = [s.lat + dy*w, s.lng - dx*w];
  let p2 = [s.lat - dy*w, s.lng + dx*w];
  let p3 = [e.lat - dy*w, e.lng + dx*w];
  let p4 = [e.lat + dy*w, e.lng - dx*w];

  return `${p1.join(",")};${p2.join(",")};${p3.join(",")};${p4.join(",")};${p1.join(",")}`;
}

function updateChips() {
  let chip = "";
  if (start) chip += `<span class="chip">AVANT : ${start.lat.toFixed(5)}, ${start.lng.toFixed(5)}</span>`;
  if (end) chip += `<span class="chip">APRÈS : ${end.lat.toFixed(5)}, ${end.lng.toFixed(5)}</span>`;
  document.getElementById("chips").innerHTML = chip;

  document.getElementById("btn").disabled = !(start && end);
}

map.on("click", async e => {
  let p = await snap(e.latlng.lat, e.latlng.lng);

  if (!start) {
    start = p;
    if (m1) map.removeLayer(m1);
    m1 = L.marker(start).addTo(map);
  } else if (!end) {
    end = p;
    if (m2) map.removeLayer(m2);
    m2 = L.marker(end).addTo(map);
  } else {
    start = p;
    end = null;
    if (m1) map.removeLayer(m1);
    if (m2) map.removeLayer(m2);
    m1 = L.marker(start).addTo(map);
  }

  updateChips();
});

// CALCUL
async function calc() {
  document.getElementById("status").innerHTML = "Calcul du détour…";

  let block = buildBlockArea(start, end);

  let url =
    `https://graphhopper.com/api/1/route?` +
    `point=${start.lat},${start.lng}&point=${end.lat},${end.lng}` +
    `&vehicle=car&locale=fr&instructions=true&calc_points=true` +
    `&block_area=${block}` +
    `&key=${API_KEY}`;

  let r = await fetch(url);
  let data = await r.json();

  if (!data.paths || !data.paths.length) {
    document.getElementById("status").innerHTML =
      "<span style='color:red;'>Impossible de calculer un détour</span>";
    return;
  }

  let path = data.paths[0];

  if (routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.polyline(
    path.points.coordinates.map(c => [c[1], c[0]]),
    { color:"blue", weight:5 }
  ).addTo(map);

  map.fitBounds(routeLayer.getBounds());

  // Affichage étapes
  let steps = path.instructions
    .map(i => `<li>${i.text} (${i.distance} m)</li>`)
    .join("");

  document.getElementById("steps").innerHTML = `<ul>${steps}</ul>`;
  document.getElementById("status").innerHTML = "";
}

document.getElementById("btn").onclick = calc;
document.getElementById("reset").onclick = () => location.reload();
</script>
