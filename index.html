<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>STM – Rues, Lignes & Arrêts</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
    }
    #map {
        width: 100%;
        height: 100%;
    }

    /* Popups style Google Maps */
    .leaflet-popup-content {
        font-size: 15px;
        font-family: Arial, sans-serif;
        line-height: 1.45;
    }
    .popup-title {
        font-weight: bold;
        font-size: 17px;
        margin-bottom: 4px;
    }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ====================================================================
//  MAP INIT (optimisé téléphone)
// ====================================================================
const map = L.map("map", {
    zoomControl: true,
    minZoom: 3,
    maxZoom: 22
}).setView([45.55, -73.65], 14);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap",
    maxZoom: 22,
    maxNativeZoom: 19
}).addTo(map);


// ====================================================================
//  ICÔNE STM (bus bleu)
// ====================================================================
const stmIcon = L.icon({
    iconUrl: "https://i.imgur.com/IIZOOia.png",
    iconSize: [38, 38],
    iconAnchor: [19, 38],
    popupAnchor: [0, -35]
});


// ====================================================================
// 1) CLIQUER SUR UNE RUE → MULTI-WAYS + LIGNES STM
// ====================================================================
let rueLayer = null;
let ligneLayer = null;

map.on("click", async (e) => {

    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    // ----------------------------------------------------
    // 1️⃣ Trouver la rue exacte (multi-ways corrigé)
    // ----------------------------------------------------
    const queryRue = `
    [out:json][timeout:25];
    way(around:10, ${lat}, ${lon})["highway"];
    out geom;
    `;

    const resRue = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: queryRue
    });

    const dataRue = await resRue.json();
    if (!dataRue.elements.length) return;

    const rue = dataRue.elements[0];

    if (rueLayer) map.removeLayer(rueLayer);

    rueLayer = L.polyline(rue.geometry.map(pt => [pt.lat, pt.lon]), {
        color: "#1A73E8",      // bleu Google Maps
        weight: 10,
        opacity: 0.85
    }).addTo(map);

    map.panTo([lat, lon]);

    // ----------------------------------------------------
    // 2️⃣ CORRECTION : trouver les lignes STM avec around()
    // ----------------------------------------------------
    const queryLignes = `
    [out:json][timeout:40];
    rel["route"="bus"]["network"="STM"](around:50, ${lat}, ${lon});
    out body;
    >;
    out skel qt;
    `;

    const resLignes = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: queryLignes
    });

    const dataLignes = await resLignes.json();

    const refs = [...new Set(
        dataLignes.elements
            .filter(el => el.type === "relation")
            .map(el => el.tags.ref)
    )];

    // Popup rue
    rueLayer.bindPopup(`
        <div class="popup-title">${rue.tags.name || "Rue inconnue"}</div>
        <b>Lignes STM :</b><br>
        ${refs.length ? refs.map(r => "• " + r).join("<br>") : "Aucune"}
    `).openPopup();


    // ----------------------------------------------------
    // 3️⃣ Afficher les tracés des lignes STM
    // ----------------------------------------------------
    if (ligneLayer) map.removeLayer(ligneLayer);
    ligneLayer = L.layerGroup();

    const ways = dataLignes.elements.filter(el => el.type === "way");

    const colors = ["#DB4437","#0F9D58","#F4B400","#00A7E1","#A142F4"];

    ways.forEach((w, i) => {
        if (!w.geometry) return;
        L.polyline(w.geometry.map(p => [p.lat, p.lon]), {
            color: colors[i % colors.length],
            weight: 6,
            opacity: 0.85
        }).addTo(ligneLayer);
    });

    ligneLayer.addTo(map);
});


// ====================================================================
// 2) AFFICHAGE DES ARRÊTS STM
// ====================================================================
async function STMStops_load() {

    const query = `
    [out:json][timeout:35];
    (
      node["highway"="bus_stop"]["operator"="STM"](area:3600065600);
      node["highway"="bus_stop"]["network"="STM"](area:3600065600);
    );
    out body;
    `;

    const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    });

    const data = await res.json();

    data.elements.forEach(stop => {

        const marker = L.marker([stop.lat, stop.lon], {
            icon: stmIcon
        }).addTo(map);

        marker.on("click", () => STMStops_showInfo(stop, marker));

    });
}


// ====================================================================
// 3) POPUP des ARRÊTS STM avec LIGNES
// ====================================================================
async function STMStops_showInfo(stop, marker) {

    const q = `
    [out:json][timeout:40];
    rel["route"="bus"]["network"="STM"](around:40, ${stop.lat}, ${stop.lon});
    out body;
    `;

    const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: q
    });

    const data = await res.json();

    const lignes = data.elements
        .filter(el => el.type === "relation")
        .map(rel => {
            const ref = rel.tags.ref || "?";
            const dir = rel.tags.direction || rel.tags.to || "";
            return dir ? `${ref} → ${dir}` : ref;
        });

    const stopId =
        stop.tags["ref:STM"] ||
        stop.tags["ref:stop_id"] ||
        stop.tags.ref ||
        stop.id;

    marker.bindPopup(`
        <div class="popup-title">${stop.tags.name || "Arrêt STM"}</div>
        <b>ID STM :</b> ${stopId}<br>
        <b>Lignes :</b><br>
        ${lignes.length ? lignes.map(l => "• " + l).join("<br>") : "Aucune"}
    `).openPopup();

    map.panTo([stop.lat, stop.lon]);
}


// Charger les arrêts STM
STMStops_load();

</script>
</body>
</html>
