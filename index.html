<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DÃ©tours STM</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { height: 100%; margin: 0; padding: 0; }
#map { height: 100%; width: 100%; }

.info-box {
    position: absolute;
    top: 10px; left: 10px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    font-size: 18px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 1000;
}
</style>
</head>

<body>

<div class="info-box">ðŸ‘‰ Clique une rue : jâ€™affiche la rue EXACTE + les lignes STM + le tracÃ©.</div>
<div id="map"></div>

<script>
const map = L.map("map").setView([45.5017, -73.5673], 15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

let streetLayer = L.geoJSON(null, {
    style: { color: "purple", weight: 6 }
}).addTo(map);

// Lignes STM â†’ mapping simple
const stmLines = [
    { line: "24", streets: ["Sherbrooke"] },
    { line: "105", streets: ["Sherbrooke"] },
    { line: "138", streets: ["Sherbrooke"] },
    { line: "356", streets: ["Sherbrooke"] }
];

// Fonction Overpass â†’ rÃ©cupÃ¨re la gÃ©omÃ©trie exacte
async function getStreetGeometry(streetName) {
    const query = `
        [out:json];
        way["name"="${streetName}"](area:3600065713);
        out geom;
    `;

    const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    });

    const json = await res.json();
    return json.elements;
}

map.on("click", async function(e) {

    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    // 1. Nom exact via reverse geocoding
    const rev = await fetch(
        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
    ).then(r => r.json());

    if (!rev.address || !rev.address.road) {
        alert("Rue inconnue.");
        return;
    }

    const street = rev.address.road;

    // 2. Lignes STM
    const lines = stmLines
        .filter(l => l.streets.some(s => street.includes(s)))
        .map(l => l.line);

    // 3. GÃ©omÃ©trie EXACTE via Overpass
    const geom = await getStreetGeometry(street);

    streetLayer.clearLayers();

    geom.forEach(w => {
        const coords = w.geometry.map(p => [p.lat, p.lon]);
        streetLayer.addData({
            type: "Feature",
            geometry: { type: "LineString", coordinates: coords.map(c => [c[1], c[0]]) }
        });
    });

    // 4. Popup
    L.popup()
        .setLatLng(e.latlng)
        .setContent(`
            <b>Rue :</b> ${street}<br>
            <b>Lignes STM :</b> ${lines.length ? lines.join(", ") : "Aucune"}
        `)
        .openOn(map);
});
</script>

</body>
</html>
